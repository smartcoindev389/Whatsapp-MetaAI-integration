---

# ✅ **STAGE 1 — MERCHANT MODULE (FINAL UPDATED REQUIREMENTS)**

**Official Specification Based on Client's Last Message**

This stage delivers a **complete, production-ready backend** allowing **each store** to connect **its own Official WhatsApp Business Account (WABA)** using **Meta’s Embedded Signup**, without any manual configuration, without system-user tokens, and without fixed WABA tokens.

Everything must be **multi-tenant**, so each store has its own WABA connection and message pipeline.

---

# 1. **Embedded Signup (Meta-Official Flow Only)**

The backend must implement the full official Embedded Signup flow:

### **1.1 Start Embedded Signup**

* Provide an endpoint that initializes the WABA connection process.
* Send App ID + redirect URI + required scopes to the frontend.

### **1.2 OAuth Redirect Callback**

Backend receives:

```
GET /auth/embedded/callback?code=xxxx&state=xxxx
```

### **1.3 Exchange OAuth code → access_token**

Call:

```
https://graph.facebook.com/v19.0/oauth/access_token
```

With:

* App ID (provided)
* App Secret (provided)
* Redirect URI
* Code

### **1.4 Fetch merchant’s WABA resources automatically**

Using the returned user access token:

Backend MUST retrieve via Graph API:

* **Business ID**
* **WABA ID (WhatsApp Business Account ID)**
* **Phone Number ID**
* **Phone display name**
* **Updated access_token** (the token returned after exchange)

⚠ **No manual input, no pre-configuration, no system-user tokens, no fixed WABA values.**
Everything must be obtained dynamically during onboarding.

### **1.5 Create merchant tenant**

Store in database:

* business_id
* waba_id
* phone_number_id
* display_name
* encrypted access_token
* token metadata (expires_at, type)
* webhook_registered = false

---

# 2. **Register Webhook Automatically**

After onboarding:

### **2.1 Register webhook endpoint**

Programmatically call Graph API:

```
POST /{app-id}/subscriptions
```

Using:

* App Secret
* Verify Token provided by client:
  `wh_meta_verify_8F92A7C3EE4B479B91D1A5BD32`
* Callback URL (your backend public URL)

### **2.2 Validate webhook (GET hub.challenge)**

Backend must:

* Compare `hub.verify_token` with client’s verify token
* If match, return `hub.challenge` raw content

### **2.3 Mark webhook as verified**

Update tenant entry:

```
webhook_verified = true
```

---

# 3. **Webhook Message Pipeline (Full and Required)**

### **3.1 POST /webhooks/meta**

* Must capture **raw body** (before JSON parsing)
* Must validate **x-hub-signature-256** via HMAC SHA256 using App Secret
* If invalid → return 401 immediately
* If valid:

  * Save **raw webhook event** in database
  * Push event into **BullMQ queue**
  * Respond **HTTP 200 immediately** (no processing here)

### **3.2 Worker (BullMQ)**

Processes all events in background:

* inbound messages
* message status updates (sent, delivered, read)
* template status changes
* errors
* conversation creation / update
* message insertion

### **3.3 Idempotency**

If Meta retries, backend must not duplicate messages.
Use messageId or eventId for deduplication.

---

# 4. **Messaging Features (Mandatory)**

### **4.1 Send text messages (24-hour window)**

Endpoint:

```
POST /messages/send
```

Backend must:

* Validate tenant
* Retrieve encrypted token
* Call:

```
POST /{phone_id}/messages
```

* Save outbound message
* Track messageId returned by Meta

### **4.2 Send template messages**

Endpoint:

```
POST /messages/template
```

Backend must:

* Fetch template metadata
* Call Meta WhatsApp Cloud API
* Save outbound event in DB

### **4.3 Status updates**

All status updates (sent, delivered, read) must be updated via webhook → queue → DB.

---

# 5. **Inbox (Mandatory)**

### **5.1 GET /inbox/conversations**

Returns:

* contact number
* last message
* last timestamp
* unread count

### **5.2 GET /inbox/conversations/{id}**

Returns:

* complete message thread
* ordered chronologically

Backend must group messages per conversation using **contactNumber + wabaAccountId**.

---

# 6. **Templates Management (Stage 1 Requirement)**

### **6.1 GET /templates**

List templates for the connected WABA.

### **6.2 POST /templates/submit**

Submit template to Meta for approval.

### **6.3 Update template statuses**

Update statuses on webhook events:

* draft
* submitted
* approved
* rejected

---

# 7. **Campaigns (Light MVP Version)**

### **7.1 POST /campaigns**

Create campaign:

* store template
* store target contacts
* create CampaignJob rows

### **7.2 Campaign Worker**

BullMQ worker must:

* send one message at a time
* default rate = **10 messages/second per phone number**
* update job + campaign status
* record failures

### **7.3 Cost calculation endpoint**

If frontend calculates cost:

* backend only provides USD price data + BRL conversion
* use caching (24h for Meta pricing, 6h for currency)

---

# 8. **Security (Mandatory)**

### **8.1 JWT authentication**

Every tenant/shop must authenticate with JWT.

### **8.2 Encrypt all tokens**

Use AES-256 or similar.
Never store plain tokens.

### **8.3 Webhook signature validation**

Using App Secret:

* capture raw body
* compute HMAC SHA256
* compare with `x-hub-signature-256` using timing-safe equal

### **8.4 Rate limit**

Per phone number:

* 10 msg/s minimum
  Use Redis to store counters.

---

# 9. **Infrastructure**

### **Required technologies:**

* **NestJS**
* **Node 18+**
* **MySQL** (Prisma or TypeORM)
* **Redis**
* **BullMQ**
* **Docker**
* **JWT**
* **Token encryption**

### **Services to run:**

* API server
* Webhook endpoint
* BullMQ worker
* MySQL
* Redis
* Optional: Bull Board for monitoring queues

---





